---
description: "Carbon timezone rules for Laravel. Always use 'America/Sao_Paulo' timezone when working with dates to ensure consistency across the application."
alwaysApply: false
---

# Carbon Timezone - Laravel Project

## Mandatory Timezone

**ALWAYS use `America/Sao_Paulo` timezone** when working with Carbon dates.

## Rules

1. **Never use Carbon without timezone** - Always specify `America/Sao_Paulo`
2. **Be consistent** - Same timezone across queries, comparisons, and storage
3. **Parse dates with timezone** - When converting user input or API data
4. **Display dates in correct timezone** - When formatting for users

## Correct Patterns

### Creating Dates

```php
use Carbon\Carbon;

// ✅ CORRECT - Always specify timezone
$now = Carbon::now('America/Sao_Paulo');
$today = Carbon::today('America/Sao_Paulo');
$tomorrow = Carbon::tomorrow('America/Sao_Paulo');

// ❌ WRONG - No timezone specified
$now = Carbon::now();  // Uses server timezone!
$today = Carbon::today();
```

### Parsing Dates

```php
// ✅ CORRECT - Parse with timezone
$publishDate = Carbon::parse($request->publish_at, 'America/Sao_Paulo');

// ✅ CORRECT - Convert existing date to correct timezone
$date = Carbon::parse($existingDate)->setTimezone('America/Sao_Paulo');

// ❌ WRONG - No timezone
$publishDate = Carbon::parse($request->publish_at);
```

### Database Queries

```php
// ✅ CORRECT - Query with timezone-aware dates
Post::where('published_at', '<=', Carbon::now('America/Sao_Paulo'))
    ->where('expires_at', '>', Carbon::now('America/Sao_Paulo'))
    ->get();

// ✅ CORRECT - Date range with timezone
Post::whereBetween('created_at', [
    Carbon::parse($startDate, 'America/Sao_Paulo')->startOfDay(),
    Carbon::parse($endDate, 'America/Sao_Paulo')->endOfDay(),
])->get();

// ❌ WRONG - Missing timezone in comparison
Post::where('published_at', '<=', Carbon::now())->get();
```

### Setting Model Attributes

```php
// ✅ CORRECT - Set with timezone
$post->published_at = Carbon::now('America/Sao_Paulo');
$post->scheduled_for = Carbon::parse($request->schedule_date, 'America/Sao_Paulo');

// ✅ CORRECT - Add time to date
$post->expires_at = Carbon::parse($request->expire_date, 'America/Sao_Paulo')
    ->setTime(23, 59, 59);

// ❌ WRONG - No timezone
$post->published_at = Carbon::now();
```

## Common Scenarios

### Publishing Posts with Schedule

```php
public function store(StorePostRequest $request)
{
    DB::transaction(function () use ($request) {
        $post = new Post($request->validated());
        
        // ✅ CORRECT - Timezone-aware scheduling
        if ($request->schedule_publish) {
            $post->published_at = Carbon::parse(
                $request->publish_date,
                'America/Sao_Paulo'
            );
        } else {
            $post->published_at = Carbon::now('America/Sao_Paulo');
        }
        
        $post->save();
    });
}
```

### Date Comparisons

```php
// ✅ CORRECT - Compare dates with timezone
public function scopePublished($query)
{
    return $query->where('published_at', '<=', Carbon::now('America/Sao_Paulo'))
        ->whereNotNull('published_at');
}

// ✅ CORRECT - Check if date is in the past
public function isExpired(): bool
{
    return $this->expires_at < Carbon::now('America/Sao_Paulo');
}

// ✅ CORRECT - Check if date is today
public function isScheduledToday(): bool
{
    $today = Carbon::today('America/Sao_Paulo');
    
    return $this->scheduled_at?->isSameDay($today);
}
```

### Date Formatting for Display

```php
// ✅ CORRECT - Format with timezone
public function getFormattedPublishedAtAttribute()
{
    return $this->published_at
        ?->setTimezone('America/Sao_Paulo')
        ->format('d/m/Y H:i');
}

// ✅ CORRECT - Human-readable dates
public function getPublishedForHumansAttribute()
{
    return $this->published_at
        ?->setTimezone('America/Sao_Paulo')
        ->diffForHumans();
}
```

### Working with Date Ranges

```php
// ✅ CORRECT - Get this week's records
public function getThisWeekRecords()
{
    $startOfWeek = Carbon::now('America/Sao_Paulo')->startOfWeek();
    $endOfWeek = Carbon::now('America/Sao_Paulo')->endOfWeek();
    
    return Post::whereBetween('created_at', [$startOfWeek, $endOfWeek])->get();
}

// ✅ CORRECT - Get last 30 days
public function getLast30Days()
{
    $thirtyDaysAgo = Carbon::now('America/Sao_Paulo')->subDays(30);
    
    return Post::where('created_at', '>=', $thirtyDaysAgo)->get();
}
```

### API Resources and JSON

```php
use Illuminate\Http\Resources\Json\JsonResource;

class PostResource extends JsonResource
{
    public function toArray($request)
    {
        return [
            'id' => $this->id,
            'title' => $this->title,
            
            // ✅ CORRECT - Format dates for API with timezone
            'published_at' => $this->published_at
                ?->setTimezone('America/Sao_Paulo')
                ->toIso8601String(),
            
            // ✅ CORRECT - Human-readable format
            'created_at_formatted' => $this->created_at
                ?->setTimezone('America/Sao_Paulo')
                ->format('d/m/Y H:i'),
        ];
    }
}
```

### Scheduled Tasks

```php
// In routes/console.php or app/Console/Kernel.php

use Illuminate\Support\Facades\Schedule;

// ✅ CORRECT - Schedule with timezone awareness
Schedule::command('reports:daily')
    ->dailyAt('08:00')
    ->timezone('America/Sao_Paulo');

Schedule::command('posts:publish')
    ->everyMinute()
    ->when(function () {
        // Check if there are posts to publish at current time
        return Post::where('published_at', '<=', Carbon::now('America/Sao_Paulo'))
            ->where('status', 'scheduled')
            ->exists();
    });
```

### Model Casts with Timezone

```php
use Illuminate\Database\Eloquent\Casts\Attribute;

class Post extends Model
{
    protected $casts = [
        'published_at' => 'datetime',
        'expires_at' => 'datetime',
    ];
    
    // ✅ CORRECT - Accessor with timezone
    protected function publishedAt(): Attribute
    {
        return Attribute::make(
            get: fn ($value) => $value 
                ? Carbon::parse($value)->setTimezone('America/Sao_Paulo')
                : null,
        );
    }
}
```

### Factories and Seeders

```php
use Database\Factories\Factory;

class PostFactory extends Factory
{
    public function definition()
    {
        return [
            'title' => fake()->sentence(),
            
            // ✅ CORRECT - Generate dates with timezone
            'published_at' => Carbon::now('America/Sao_Paulo')
                ->subDays(rand(1, 30)),
            
            'created_at' => Carbon::now('America/Sao_Paulo')
                ->subDays(rand(31, 60)),
        ];
    }
}
```

### Validation with Dates

```php
use Illuminate\Foundation\Http\FormRequest;

class StorePostRequest extends FormRequest
{
    public function rules()
    {
        return [
            'title' => 'required|string|max:255',
            
            // ✅ CORRECT - Validate date is in future (timezone-aware)
            'publish_at' => [
                'nullable',
                'date',
                function ($attribute, $value, $fail) {
                    $publishDate = Carbon::parse($value, 'America/Sao_Paulo');
                    $now = Carbon::now('America/Sao_Paulo');
                    
                    if ($publishDate->lt($now)) {
                        $fail('The publish date must be in the future.');
                    }
                },
            ],
        ];
    }
}
```

## Configuration

In `config/app.php`, ensure timezone is set:

```php
'timezone' => 'America/Sao_Paulo',
```

## Database Considerations

**IMPORTANT:** Store dates in UTC in database, but always convert to `America/Sao_Paulo` when:
- Displaying to users
- Making comparisons
- Querying records

Laravel's Eloquent automatically handles timezone conversion if configured correctly.

## Testing with Dates

```php
use Illuminate\Foundation\Testing\RefreshDatabase;

class PostTest extends TestCase
{
    use RefreshDatabase;
    
    public function test_publishes_post_at_correct_time()
    {
        // ✅ CORRECT - Test with timezone
        $publishTime = Carbon::parse('2024-12-01 10:00:00', 'America/Sao_Paulo');
        
        $post = Post::factory()->create([
            'published_at' => $publishTime,
            'status' => 'scheduled',
        ]);
        
        // Travel to just before publish time
        $this->travelTo($publishTime->copy()->subMinute());
        $this->assertFalse($post->isPublished());
        
        // Travel to publish time
        $this->travelTo($publishTime);
        $this->assertTrue($post->isPublished());
    }
}
```

## Why This Matters

Using consistent timezone prevents:
- Posts publishing at wrong times
- Incorrect date comparisons
- Confusion between server time and local time
- Reports showing wrong date ranges
- Scheduled tasks running at unexpected times

**Remember:** Always specify `'America/Sao_Paulo'` when working with Carbon!
